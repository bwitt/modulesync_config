#!/usr/bin/env ruby
require 'puppet_metadata'

def update_badges(readme_path)
  begin
    content = File.read(readme_path)
  rescue => e
    warn "Skipping #{readme_path}: #{e.message}"
    return
  end
  
  metadata_path = File.join(File.dirname(readme_path), 'metadata.json')
  metadata = begin
               PuppetMetadata.read(metadata_path)
             rescue => e
               warn "Skipping #{readme_path}: Could not read metadata.json: #{e.message}"
               return
             end

  source = metadata.metadata['source'] || ''

  # Parse org and repo from source URL
  # Handles https://github.com/org/repo and git@github.com:org/repo.git
  if (match = source.match(/github\.com[:\/]([^\/]+)\/([^\/]+?)(?:\.git)?$/))
    org_name = match[1]
    module_name = match[2]
  else
    warn "Skipping #{readme_path}: Source URL is missing or invalid: #{source}"
    return
  end

  forge_slug = metadata.name.sub('-', '/')
  license_text = metadata.license ? "#{metadata.license} License" : 'License'

  badges = {
    'Build Status' => {
      regex: /\[!\[Build Status\]\(.*?\)\].*?\)/,
      replacement: "[![Build Status](https://github.com/#{org_name}/#{module_name}/actions/workflows/ci.yml/badge.svg)](https://github.com/#{org_name}/#{module_name}/actions/workflows/ci.yml)"
    },
    'Release' => {
      regex: /\[!\[Release\]\(.*?\)\].*?\)/,
      replacement: "[![Release](https://github.com/#{org_name}/#{module_name}/actions/workflows/release.yml/badge.svg)](https://github.com/#{org_name}/#{module_name}/actions/workflows/release.yml)"
    },
    'Puppet Forge' => {
      regex: /\[!\[Puppet Forge\]\(.*?\)\].*?\)/,
      replacement: "[![Puppet Forge](https://img.shields.io/puppetforge/v/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})"
    },
    'Puppet Forge - downloads' => {
      regex: /\[!\[Puppet Forge - downloads\]\(.*?\)\].*?\)/,
      replacement: "[![Puppet Forge - downloads](https://img.shields.io/puppetforge/dt/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})"
    },
    'Puppet Forge - endorsement' => {
      regex: /\[!\[Puppet Forge - endorsement\]\(.*?\)\].*?\)/,
      replacement: "[![Puppet Forge - endorsement](https://img.shields.io/puppetforge/e/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})"
    },
    'Puppet Forge - scores' => {
      regex: /\[!\[Puppet Forge - scores\]\(.*?\)\].*?\)/,
      replacement: "[![Puppet Forge - scores](https://img.shields.io/puppetforge/f/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})"
    },
    'puppetmodule.info docs' => {
      regex: /\[!\[puppetmodule\.info docs\]\(.*?\)\].*?\)/,
      replacement: "[![puppetmodule.info docs](http://www.puppetmodule.info/images/badge.png)](http://www.puppetmodule.info/m/#{module_name})"
    },
    'License' => {
      regex: /\[!\[.*?License\]\(.*?\)\].*?\)/,
      replacement: "[![#{license_text}](https://img.shields.io/github/license/#{org_name}/#{module_name}.svg)](LICENSE)"
    }
  }

  changed = false
  badges.each do |name, data|
    if content.match?(data[:regex])
      new_content = content.gsub(data[:regex], data[:replacement])
      if new_content != content
        content = new_content
        changed = true
      end
    end
  end

  if changed
    File.write(readme_path, content)
    puts "Updated #{readme_path}"
  end
end

files = ARGV.empty? ? Dir.glob('modules/*/*/README.md') : ARGV

files.each do |file|
  update_badges(file)
end
