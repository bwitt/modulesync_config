#!/usr/bin/env ruby
require 'puppet_metadata'

def update_badges(readme_path)
  begin
    content = File.read(readme_path)
  rescue => e
    warn "Skipping #{readme_path}: #{e.message}"
    return
  end
  
  metadata_path = File.join(File.dirname(readme_path), 'metadata.json')
  metadata = begin
               PuppetMetadata.read(metadata_path)
             rescue => e
               warn "Skipping #{readme_path}: Could not read metadata.json: #{e.message}"
               return
             end

  source = metadata.metadata['source'] || ''

  # Parse org and repo from source URL
  # Handles https://github.com/org/repo and git@github.com:org/repo.git
  if (match = source.match(/github\.com[:\/]([^\/]+)\/([^\/]+?)(?:\.git)?$/))
    org_name = match[1]
    module_name = match[2]
  else
    warn "Skipping #{readme_path}: Source URL is missing or invalid: #{source}"
    return
  end

  forge_slug = metadata.name.sub('-', '/')
  license_text = metadata.license ? "#{metadata.license} License" : 'License'

  new_badges = [
    "[![Build Status](https://github.com/#{org_name}/#{module_name}/actions/workflows/ci.yml/badge.svg)](https://github.com/#{org_name}/#{module_name}/actions/workflows/ci.yml)",
    "[![Release](https://github.com/#{org_name}/#{module_name}/actions/workflows/release.yml/badge.svg)](https://github.com/#{org_name}/#{module_name}/actions/workflows/release.yml)",
    "[![Puppet Forge](https://img.shields.io/puppetforge/v/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})",
    "[![Puppet Forge - downloads](https://img.shields.io/puppetforge/dt/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})",
    "[![Puppet Forge - endorsement](https://img.shields.io/puppetforge/e/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})",
    "[![Puppet Forge - scores](https://img.shields.io/puppetforge/f/#{forge_slug}.svg)](https://forge.puppetlabs.com/#{forge_slug})",
    "[![puppetmodule.info docs](http://www.puppetmodule.info/images/badge.png)](http://www.puppetmodule.info/m/#{module_name})",
    "[![#{license_text}](https://img.shields.io/github/license/#{org_name}/#{module_name}.svg)](LICENSE)"
  ]

  # Regex to match a block of badges (lines starting with [![...)
  # Note: We do NOT use /m modifier so that . does not match newlines
  badge_block_regex = /(?:^\s*\[!\[.*?\]\(.*?\).*$\n?)+/

  if content.match?(badge_block_regex)
    content = content.sub(badge_block_regex) do |match|
      # Preserve "Donated by" badge if present
      if match.include?("Donated by")
        donated_line = match.lines.find { |l| l.include?("Donated by") }
        new_badges << donated_line.strip if donated_line
      end
      new_badges.join("\n") + "\n"
    end
    
    File.write(readme_path, content)
    puts "Updated #{readme_path}"
  end
end

files = ARGV.empty? ? Dir.glob('modules/*/*/README.md') : ARGV

files.each do |file|
  update_badges(file)
end
